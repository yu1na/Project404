<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%-- calendar.jspëŠ” base.jspì— ì˜í•´ í¬í•¨ë  ê²ƒì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” HTML êµ¬ì¡° íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. --%>

    <h2>ğŸ“… ì¼ì • ê´€ë¦¬</h2>
    <div id="calendar"></div>

    <%-- ì´ë²¤íŠ¸ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ (ì´ ë¶€ë¶„ì€ calendar.jspì— ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤) --%>
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="eventModalLabel">ì¼ì • ìƒì„¸/ìˆ˜ì •</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="eventForm">
              <input type="hidden" id="eventId">
              <div class="mb-3">
                <label for="eventTitle" class="form-label">ì œëª©</label>
                <input type="text" class="form-control" id="eventTitle" required>
              </div>
              <div class="mb-3">
                <label for="eventDescription" class="form-label">ì„¤ëª…/ë¹„ê³ </label>
                <textarea class="form-control" id="eventDescription" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label for="eventStart" class="form-label">ì‹œì‘ì¼ì‹œ</label>
                <input type="datetime-local" class="form-control" id="eventStart" required>
              </div>
              <div class="mb-3">
                <label for="eventEnd" class="form-label">ì¢…ë£Œì¼ì‹œ</label>
                <input type="datetime-local" class="form-control" id="eventEnd">
              </div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="eventAllDay">
                <label class="form-check-label" for="eventAllDay">ì¢…ì¼</label>
              </div>
              <div class="mb-3">
                <label for="eventColor" class="form-label">ìƒ‰ìƒ</label>
                <input type="color" class="form-control form-control-color" id="eventColor" value="#007bff">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-auto" id="deleteEventBtn">ì‚­ì œ</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            <button type="button" class="btn btn-primary" id="saveEventBtn">ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'ko', // í•œêµ­ì–´ ì ìš©
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                initialView: 'dayGridMonth',
                editable: true,
                selectable: true,
                dayMaxEvents: true,
                eventLimit: true,

                // ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë“œ
                events: function(fetchInfo, successCallback, failureCallback) {
                    $.ajax({
                        url: '/calendar/events', // CalendarControllerì˜ getCalendarEvents ë§¤í•‘
                        method: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            successCallback(data);
                        },
                        error: function(xhr, status, error) {
                            console.error("ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ", status, error);
                            alert("ì´ë²¤íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            failureCallback(error);
                        }
                    });
                },

                // ë‚ ì§œ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
                select: function(info) {
                    $('#eventId').val(''); // ID ì´ˆê¸°í™” (ìƒˆ ì´ë²¤íŠ¸)
                    $('#eventTitle').val('');
                    $('#eventDescription').val('');
                    $('#eventStart').val(moment(info.startStr).format('YYYY-MM-DDTHH:mm'));
                    $('#eventEnd').val(moment(info.endStr).format('YYYY-MM-DDTHH:mm'));
                    $('#eventAllDay').prop('checked', info.allDay);
                    $('#eventColor').val('#007bff');
                    $('#deleteEventBtn').hide(); // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹œ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€

                    eventModal.show();
                },

                // ì´ë²¤íŠ¸ í´ë¦­ ì‹œ ìƒì„¸/ìˆ˜ì •
                eventClick: function(info) {
                    var event = info.event;
                    $('#eventId').val(event.id);
                    $('#eventTitle').val(event.title);
                    $('#eventDescription').val(event.extendedProps.description || '');
                    $('#eventStart').val(moment(event.start).format('YYYY-MM-DDTHH:mm'));
                    $('#eventEnd').val(event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm') : '');
                    $('#eventAllDay').prop('checked', event.allDay);
                    $('#eventColor').val(event.backgroundColor || '#007bff');
                    $('#deleteEventBtn').show(); // ê¸°ì¡´ ì´ë²¤íŠ¸ëŠ” ì‚­ì œ ë²„íŠ¼ ë³´ì„

                    eventModal.show();
                },

                // ì´ë²¤íŠ¸ ë“œë˜ê·¸ í›„ ë‚ ì§œ ë³€ê²½
                eventDrop: function(info) {
                    var event = info.event;
                    var updatedEvent = {
                        id: event.id,
                        title: event.title,
                        start: moment(event.start).format('YYYY-MM-DDTHH:mm:ss'),
                        end: event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm:ss') : null,
                        allDay: event.allDay,
                        color: event.backgroundColor,
                        description: event.extendedProps.description || ''
                    };
                    updateEvent(updatedEvent, info.revert);
                },

                // ì´ë²¤íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ í›„ ê¸°ê°„ ë³€ê²½
                eventResize: function(info) {
                    var event = info.event;
                    var updatedEvent = {
                        id: event.id,
                        title: event.title,
                        start: moment(event.start).format('YYYY-MM-DDTHH:mm:ss'),
                        end: event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm:ss') : null,
                        allDay: event.allDay,
                        color: event.backgroundColor,
                        description: event.extendedProps.description || ''
                    };
                    updateEvent(updatedEvent, info.revert);
                }
            });

            calendar.render(); // ìº˜ë¦°ë” ê·¸ë¦¬ê¸°

            // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
            $('#saveEventBtn').on('click', function() {
                var eventId = $('#eventId').val();
                var eventData = {
                    title: $('#eventTitle').val(),
                    description: $('#eventDescription').val(),
                    start: moment($('#eventStart').val()).format('YYYY-MM-DDTHH:mm:ss'),
                    end: $('#eventEnd').val() ? moment($('#eventEnd').val()).format('YYYY-MM-DDTHH:mm:ss') : null,
                    allDay: $('#eventAllDay').is(':checked'),
                    color: $('#eventColor').val()
                };

                if (eventId) { // ê¸°ì¡´ ì´ë²¤íŠ¸ ìˆ˜ì •
                    updateEvent(Object.assign({id: Number(eventId)}, eventData));
                } else { // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
                    addEvent(eventData);
                }
                eventModal.hide();
            });

            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
            $('#deleteEventBtn').on('click', function() {
                if (confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    var eventId = $('#eventId').val();
                    deleteEvent(Number(eventId));
                    eventModal.hide();
                }
            });

            // --- API ì—°ë™ í•¨ìˆ˜ë“¤ ---
            function addEvent(eventData) {
                $.ajax({
                    url: '/calendar/events',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    success: function(response) {
                        calendar.addEvent(response);
                        alert('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨: ", status, error);
                        alert("ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }

            function updateEvent(eventData, revertFunc) {
                $.ajax({
                    url: '/calendar/events/' + eventData.id,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    success: function(response) {
                        alert('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ìˆ˜ì • ì‹¤íŒ¨: ", status, error);
                        alert("ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        if (revertFunc) revertFunc();
                    }
                });
            }

            function deleteEvent(eventId) {
                $.ajax({
                    url: '/calendar/events/' + eventId,
                    method: 'DELETE',
                    success: function() {
                        calendar.getEventById(eventId).remove();
                        alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ", status, error);
                        alert("ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }
        });
    </script>