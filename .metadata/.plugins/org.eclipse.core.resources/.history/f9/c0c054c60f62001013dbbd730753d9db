<%@ page language="java" contentType="text/html; charset=UTF-UTF-8" pageEncoding="UTF-8"%>
<%-- <!DOCTYPE html>, <html>, <head>, <body> íƒœê·¸ëŠ” top.jspì—ì„œ ì´ë¯¸ ì‹œì‘ë©ë‹ˆë‹¤. --%>

<%-- ì´ íŒŒì¼ì€ top.jspì˜ main-content ì•ˆì— í¬í•¨ë  ë‚´ìš©ë§Œ ê°€ì§‘ë‹ˆë‹¤. --%>
  <h2>ğŸ“… ì¼ì • ê´€ë¦¬</h2>
  <div id="calendar"></div>

<%-- FullCalendar JavaScript ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ìŠ¤í¬ë¦½íŠ¸ --%>
<%-- ì´ ìŠ¤í¬ë¦½íŠ¸ë“¤ì€ top.jspì—ì„œ <body> íƒœê·¸ê°€ ë‹«íˆê¸° ì „ì— í•œë²ˆë§Œ ë¡œë“œë˜ì–´ì•¼ í•©ë‹ˆë‹¤. --%>
<%-- ë”°ë¼ì„œ, ì´ ë‚´ìš©ì€ top.jsp íŒŒì¼ì˜ </body> ë‹«ëŠ” íƒœê·¸ ë°”ë¡œ ìœ„ì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. --%>
<%-- (ì•„ë˜ script ë¸”ë¡ì€ calendar.jspì—ì„œ ì œê±°í•˜ê³  top.jspë¡œ ì´ë™í•´ì•¼ í•¨) --%>
<script>
    // ì´ì „ì— calendar.jspì— ìˆë˜ JavaScript ì½”ë“œë¥¼ ì—¬ê¸°ì— ì˜®ê²¨ì˜µë‹ˆë‹¤.
    // DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì—¬ì „íˆ í•„ìš”í•©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'ko',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            initialView: 'dayGridMonth',
            editable: true,
            selectable: true,
            dayMaxEvents: true,
            eventLimit: true,

            events: function(fetchInfo, successCallback, failureCallback) {
                $.ajax({
                    url: '/calendar/events',
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        successCallback(data);
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ", status, error);
                        alert("ì´ë²¤íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        failureCallback(error);
                    }
                });
            },

            select: function(info) {
                $('#eventId').val('');
                $('#eventTitle').val('');
                $('#eventDescription').val('');
                $('#eventStart').val(moment(info.startStr).format('YYYY-MM-DDTHH:mm'));
                $('#eventEnd').val(moment(info.endStr).format('YYYY-MM-DDTHH:mm'));
                $('#eventAllDay').prop('checked', info.allDay);
                $('#eventColor').val('#007bff');
                $('#deleteEventBtn').hide();

                eventModal.show();
            },

            eventClick: function(info) {
                var event = info.event;
                $('#eventId').val(event.id);
                $('#eventTitle').val(event.title);
                $('#eventDescription').val(event.extendedProps.description || '');
                $('#eventStart').val(moment(event.start).format('YYYY-MM-DDTHH:mm'));
                $('#eventEnd').val(event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm') : '');
                $('#eventAllDay').prop('checked', event.allDay);
                $('#eventColor').val(event.backgroundColor || '#007bff');
                $('#deleteEventBtn').show();

                eventModal.show();
            },

            eventDrop: function(info) {
                var event = info.event;
                var updatedEvent = {
                    id: event.id,
                    title: event.title,
                    start: moment(event.start).format('YYYY-MM-DDTHH:mm:ss'),
                    end: event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm:ss') : null,
                    allDay: event.allDay,
                    color: event.backgroundColor,
                    description: event.extendedProps.description || ''
                };
                updateEvent(updatedEvent, info.revert);
            },

            eventResize: function(info) {
                var event = info.event;
                var updatedEvent = {
                    id: event.id,
                    title: event.title,
                    start: moment(event.start).format('YYYY-MM-DDTHH:mm:ss'),
                    end: event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm:ss') : null,
                    allDay: event.allDay,
                    color: event.backgroundColor,
                    description: event.extendedProps.description || ''
                };
                updateEvent(updatedEvent, info.revert);
            }
        });

        calendar.render();

        $('#saveEventBtn').on('click', function() {
            var eventId = $('#eventId').val();
            var eventData = {
                title: $('#eventTitle').val(),
                description: $('#eventDescription').val(),
                start: moment($('#eventStart').val()).format('YYYY-MM-DDTHH:mm:ss'),
                end: $('#eventEnd').val() ? moment($('#eventEnd').val()).format('YYYY-MM-DDTHH:mm:ss') : null,
                allDay: $('#eventAllDay').is(':checked'),
                color: $('#eventColor').val()
            };

            if (eventId) {
                updateEvent(Object.assign({id: Number(eventId)}, eventData));
            } else {
                addEvent(eventData);
            }
            eventModal.hide();
        });

        $('#deleteEventBtn').on('click', function() {
            if (confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                var eventId = $('#eventId').val();
                deleteEvent(Number(eventId));
                eventModal.hide();
            }
        });

        function addEvent(eventData) {
            $.ajax({
                url: '/calendar/events',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(eventData),
                success: function(response) {
                    calendar.addEvent(response);
                    alert('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                error: function(xhr, status, error) {
                    console.error("ì´ë²¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨: ", status, error);
                    alert("ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        function updateEvent(eventData, revertFunc) {
            $.ajax({
                url: '/calendar/events/' + eventData.id,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(eventData),
                success: function(response) {
                    alert('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                error: function(xhr, status, error) {
                    console.error("ì´ë²¤íŠ¸ ìˆ˜ì • ì‹¤íŒ¨: ", status, error);
                    alert("ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    if (revertFunc) revertFunc();
                }
            });
        }

        function deleteEvent(eventId) {
            $.ajax({
                url: '/calendar/events/' + eventId,
                method: 'DELETE',
                success: function() {
                    calendar.getEventById(eventId).remove();
                    alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                error: function(xhr, status, error) {
                    console.error("ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ", status, error);
                    alert("ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
    });
</script>

<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">ì¼ì • ìƒì„¸/ìˆ˜ì •</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">
          <div class="mb-3">
            <label for="eventTitle" class="form-label">ì œëª©</label>
            <input type="text" class="form-control" id="eventTitle" required>
          </div>
          <div class="mb-3">
            <label for="eventDescription" class="form-label">ì„¤ëª…/ë¹„ê³ </label>
            <textarea class="form-control" id="eventDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="eventStart" class="form-label">ì‹œì‘ì¼ì‹œ</label>
            <input type="datetime-local" class="form-control" id="eventStart" required>
          </div>
          <div class="mb-3">
            <label for="eventEnd" class="form-label">ì¢…ë£Œì¼ì‹œ</label>
            <input type="datetime-local" class="form-control" id="eventEnd">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="eventAllDay">
            <label class="form-check-label" for="eventAllDay">ì¢…ì¼</label>
          </div>
          <div class="mb-3">
            <label for="eventColor" class="form-label">ìƒ‰ìƒ</label>
            <input type="color" class="form-control form-control-color" id="eventColor" value="#007bff">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" id="deleteEventBtn">ì‚­ì œ</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        <button type="button" class="btn btn-primary" id="saveEventBtn">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

