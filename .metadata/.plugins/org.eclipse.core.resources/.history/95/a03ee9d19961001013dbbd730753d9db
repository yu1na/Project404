<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%-- ìƒë‹¨ ë©”ë‰´ì™€ ì‚¬ì´ë“œë°”ë¥¼ í¬í•¨ --%>
<%@ include file="/WEB-INF/views/top.jsp" %>
<%@ include file="/WEB-INF/views/sidebar.jsp" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì¼ì • ê´€ë¦¬</title>
    <%-- Bootstrap CSS (top.jspì— ì´ë¯¸ ìˆì§€ë§Œ, í˜¹ì‹œ ëª°ë¼ í•œ ë²ˆ ë”) --%>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <%-- FullCalendar CSS --%>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/main.min.css' rel='stylesheet' />
    <style>
        body {
            display: flex; /* top.jspì™€ sidebar.jspì˜ êµ¬ì¡°ë¥¼ ê³ ë ¤ */
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .main-content-wrapper {
            margin-left: 220px; /* ì‚¬ì´ë“œë°” ë„ˆë¹„ + ì—¬ë°± */
            padding: 20px;
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ */
        }
        #calendar {
            max-width: 900px; /* ìº˜ë¦°ë” ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* FullCalendar ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¡°ì • */
        .fc-toolbar-title {
            font-size: 1.5em; /* íƒ€ì´í‹€ í¬ê¸° */
            color: #004080;
        }
        .fc-button {
            background-color: #0056b3 !important;
            border-color: #0056b3 !important;
            color: white !important;
        }
        .fc-button:hover {
            background-color: #004080 !important;
            border-color: #004080 !important;
        }
        .fc-today-button {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
        }
        .fc-today-button:hover {
            background-color: #218838 !important;
            border-color: #218838 !important;
        }
    </style>
</head>
<body>

    <div class="main-content-wrapper">
      <h2>ğŸ“… ì¼ì • ê´€ë¦¬</h2>
      <div id="calendar"></div>
    </div>

    <%-- jQuery (FullCalendar í•„ìš”) --%>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <%-- Bootstrap 5 JS (ëª¨ë‹¬ ë“±) --%>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <%-- FullCalendar Core JS --%>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>
    <%-- FullCalendar í•œêµ­ì–´ ë¡œì¼€ì¼ (ì˜µì…˜) --%>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/ko.global.min.js'></script>
    <%-- moment.js (ë‚ ì§œ íŒŒì‹± ë° í¬ë§·íŒ…, FullCalendarì™€ ì§ì ‘ì ì¸ ì˜ì¡´ì„±ì€ ì•„ë‹ˆë‚˜ í¸ì˜ìƒ ì‚¬ìš©) --%>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>


    <%-- ì´ë²¤íŠ¸ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ --%>
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="eventModalLabel">ì¼ì • ìƒì„¸/ìˆ˜ì •</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="eventForm">
              <input type="hidden" id="eventId">
              <div class="mb-3">
                <label for="eventTitle" class="form-label">ì œëª©</label>
                <input type="text" class="form-control" id="eventTitle" required>
              </div>
              <div class="mb-3">
                <label for="eventDescription" class="form-label">ì„¤ëª…/ë¹„ê³ </label>
                <textarea class="form-control" id="eventDescription" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label for="eventStart" class="form-label">ì‹œì‘ì¼ì‹œ</label>
                <input type="datetime-local" class="form-control" id="eventStart" required>
              </div>
              <div class="mb-3">
                <label for="eventEnd" class="form-label">ì¢…ë£Œì¼ì‹œ</label>
                <input type="datetime-local" class="form-control" id="eventEnd">
              </div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="eventAllDay">
                <label class="form-check-label" for="eventAllDay">ì¢…ì¼</label>
              </div>
              <div class="mb-3">
                <label for="eventColor" class="form-label">ìƒ‰ìƒ</label>
                <input type="color" class="form-control form-control-color" id="eventColor" value="#007bff">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-auto" id="deleteEventBtn">ì‚­ì œ</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            <button type="button" class="btn btn-primary" id="saveEventBtn">ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'ko', // í•œêµ­ì–´ ì ìš©
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                initialView: 'dayGridMonth',
                editable: true,
                selectable: true,
                dayMaxEvents: true,
                eventLimit: true,

                // ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë“œ
                events: function(fetchInfo, successCallback, failureCallback) {
                    $.ajax({
                        url: '/calendar/events', // CalendarControllerì˜ getCalendarEvents ë§¤í•‘
                        method: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            // FullCalendarëŠ” idë¥¼ ë¬¸ìì—´ë¡œë„ ì˜ ì²˜ë¦¬í•˜ë¯€ë¡œ, Long íƒ€ì…ì´ ê·¸ëŒ€ë¡œ ì™€ë„ ë¬¸ì œ ì—†ìŒ
                            successCallback(data);
                        },
                        error: function(xhr, status, error) {
                            console.error("ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ", status, error);
                            alert("ì´ë²¤íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            failureCallback(error);
                        }
                    });
                },

                // ë‚ ì§œ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
                select: function(info) {
                    $('#eventId').val(''); // ID ì´ˆê¸°í™” (ìƒˆ ì´ë²¤íŠ¸)
                    $('#eventTitle').val('');
                    $('#eventDescription').val('');
                    // FullCalendar info.start/endëŠ” Date ê°ì²´. momentë¡œ í¬ë§·íŒ…
                    $('#eventStart').val(moment(info.startStr).format('YYYY-MM-DDTHH:mm'));
                    $('#eventEnd').val(moment(info.endStr).format('YYYY-MM-DDTHH:mm'));
                    $('#eventAllDay').prop('checked', info.allDay);
                    $('#eventColor').val('#007bff');
                    $('#deleteEventBtn').hide(); // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹œ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€

                    eventModal.show();
                },

                // ì´ë²¤íŠ¸ í´ë¦­ ì‹œ ìƒì„¸/ìˆ˜ì •
                eventClick: function(info) {
                    var event = info.event;
                    $('#eventId').val(event.id); // Long íƒ€ì… IDê°€ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°
                    $('#eventTitle').val(event.title);
                    $('#eventDescription').val(event.extendedProps.description || '');
                    $('#eventStart').val(moment(event.start).format('YYYY-MM-DDTHH:mm'));
                    $('#eventEnd').val(event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm') : ''); // ì¢…ë£Œì¼ì´ ì—†ìœ¼ë©´ ë¹ˆ ê°’
                    $('#eventAllDay').prop('checked', event.allDay);
                    $('#eventColor').val(event.backgroundColor || '#007bff');
                    $('#deleteEventBtn').show(); // ê¸°ì¡´ ì´ë²¤íŠ¸ëŠ” ì‚­ì œ ë²„íŠ¼ ë³´ì„

                    eventModal.show();
                },

                // ì´ë²¤íŠ¸ ë“œë˜ê·¸ í›„ ë‚ ì§œ ë³€ê²½
                eventDrop: function(info) {
                    var event = info.event;
                    var updatedEvent = {
                        id: event.id, // IDëŠ” Long íƒ€ì…ìœ¼ë¡œ ì„œë²„ì— ì „ë‹¬
                        title: event.title,
                        start: moment(event.start).format('YYYY-MM-DDTHH:mm:ss'),
                        end: event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm:ss') : null,
                        allDay: event.allDay,
                        color: event.backgroundColor,
                        description: event.extendedProps.description || ''
                    };
                    updateEvent(updatedEvent, info.revert);
                },

                // ì´ë²¤íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ í›„ ê¸°ê°„ ë³€ê²½
                eventResize: function(info) {
                    var event = info.event;
                    var updatedEvent = {
                        id: event.id, // IDëŠ” Long íƒ€ì…ìœ¼ë¡œ ì„œë²„ì— ì „ë‹¬
                        title: event.title,
                        start: moment(event.start).format('YYYY-MM-DDTHH:mm:ss'),
                        end: event.end ? moment(event.end).format('YYYY-MM-DDTHH:mm:ss') : null,
                        allDay: event.allDay,
                        color: event.backgroundColor,
                        description: event.extendedProps.description || ''
                    };
                    updateEvent(updatedEvent, info.revert);
                }
            });

            calendar.render(); // ìº˜ë¦°ë” ê·¸ë¦¬ê¸°

            // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
            $('#saveEventBtn').on('click', function() {
                var eventId = $('#eventId').val(); // ë¬¸ìì—´ í˜•íƒœì˜ ID
                var eventData = {
                    title: $('#eventTitle').val(),
                    description: $('#eventDescription').val(),
                    start: moment($('#eventStart').val()).format('YYYY-MM-DDTHH:mm:ss'),
                    end: $('#eventEnd').val() ? moment($('#eventEnd').val()).format('YYYY-MM-DDTHH:mm:ss') : null,
                    allDay: $('#eventAllDay').is(':checked'),
                    color: $('#eventColor').val()
                };

                if (eventId) { // ê¸°ì¡´ ì´ë²¤íŠ¸ ìˆ˜ì •
                    // JavaScriptì—ì„œ ë°›ì€ IDëŠ” ë¬¸ìì—´ì´ë¯€ë¡œ, Longìœ¼ë¡œ ë³€í™˜ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ì—¬ ë³´ëƒ…ë‹ˆë‹¤.
                    // Springì˜ @PathVariable Long idê°€ ë¬¸ìì—´ì„ ìë™ìœ¼ë¡œ Longìœ¼ë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.
                    updateEvent(Object.assign({id: Number(eventId)}, eventData)); // Number()ë¡œ ëª…ì‹œì  ë³€í™˜
                } else { // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
                    addEvent(eventData);
                }
                eventModal.hide();
            });

            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
            $('#deleteEventBtn').on('click', function() {
                if (confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    var eventId = $('#eventId').val(); // ë¬¸ìì—´ í˜•íƒœì˜ ID
                    deleteEvent(Number(eventId)); // Number()ë¡œ ëª…ì‹œì  ë³€í™˜
                    eventModal.hide();
                }
            });

            // --- API ì—°ë™ í•¨ìˆ˜ë“¤ ---
            function addEvent(eventData) {
                $.ajax({
                    url: '/calendar/events',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    success: function(response) {
                        // ì„œë²„ì—ì„œ Long íƒ€ì…ì˜ idê°€ ë°˜í™˜ë˜ë¯€ë¡œ, ê·¸ëŒ€ë¡œ FullCalendarì— ì¶”ê°€.
                        // FullCalendarëŠ” ìˆ«ì IDë„ ì˜ ì²˜ë¦¬í•¨.
                        calendar.addEvent(response);
                        alert('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨: ", status, error);
                        alert("ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }

            function updateEvent(eventData, revertFunc) {
                $.ajax({
                    url: '/calendar/events/' + eventData.id, // eventData.idëŠ” ì´ë¯¸ Numberë¡œ ë³€í™˜ë¨
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    success: function(response) {
                        alert('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ìˆ˜ì • ì‹¤íŒ¨: ", status, error);
                        alert("ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        if (revertFunc) revertFunc();
                    }
                });
            }

            function deleteEvent(eventId) { // eventIdëŠ” ì´ë¯¸ Numberë¡œ ë³€í™˜ë¨
                $.ajax({
                    url: '/calendar/events/' + eventId,
                    method: 'DELETE',
                    success: function() {
                        calendar.getEventById(eventId).remove();
                        alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    },
                    error: function(xhr, status, error) {
                        console.error("ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ", status, error);
                        alert("ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }
        });
    </script>
</body>
</html>